#!/bin/sh --
set -e

[[ -d "$1" ]] || exit 1
cd "$1"

parse_cmdline() {
	local value unit

	set -f
	read -r cmdline
	set -- $cmdline
	set +f

	for item; do
		case $item in
		rd.sysroot=*) value=${item#*=}; break ;;
		esac
	done

	[[ $value ]] || return

	unit=sysroot-bind.service
	cat <<-! > $unit
	# Automatically generated by sysroot-generator

	[Unit]
	SourcePath=/proc/cmdline
	Before=initrd-root-fs.target
	Requires=sysroot.mount
	After=sysroot.mount

	[Service]
	Type=oneshot
	RemainAfterExit=yes
	ExecStart=/usr/bin/mount -o bind /sysroot/$value /sysroot
	!

	mkdir -p initrd-root-fs.target.requires
	ln -s ../$unit initrd-root-fs.target.requires/$unit
}

parse_cmdline < /proc/cmdline
