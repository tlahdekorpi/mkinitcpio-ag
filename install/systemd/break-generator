#!/bin/sh --
sd_generator="$1"
sd_target_wants=/run/systemd/system/initrd.target.wants

[[ "$sd_generator" ]] || exit 1

service() { cat <<!
# Automatically generated by initrd-break-generator

[Service]
Type=oneshot
ExecStart=-/usr/bin/sulogin
StandardInput=tty-force
StandardOutput=inherit
StandardError=inherit
KillMode=process
IgnoreSIGPIPE=no
TasksMax=infinity
KillSignal=SIGHUP

[Unit]
Description=Initrd $1 break
SourcePath=/proc/cmdline
DefaultDependencies=no
Conflicts=shutdown.target emergency.target
!
}

premount() { cat <<!
Wants=systemd-vconsole-setup.service
After=systemd-vconsole-setup.service
Before=initrd-root-fs.target sysroot.mount systemd-fsck-root.service
!
}

postmount() { cat <<!
Wants=remote-fs.target systemd-vconsole-setup.service
After=remote-fs.target systemd-vconsole-setup.service
After=initrd.target initrd-parse-etc.service sysroot.mount
Before=initrd-cleanup.service
!
}

parse_cmdline() {
	local key value unit

	set -f
	read -r cmdline
	set -- $cmdline
	set +f

	for item; do
		case $item in
		break*|rd.break*) key=$item; break ;;
		esac
	done

	[[ $key ]] || return
	value=${key#*=}

	case $value in
	premount|postmount) ;;
	*) value=postmount ;;
	esac

	unit="initrd-$value-break.service"

	(service $value; $value) > $sd_generator/$unit

	mkdir -p $sd_target_wants
	ln -s $sd_generator/$unit $sd_target_wants/$unit
}

parse_cmdline < /proc/cmdline
