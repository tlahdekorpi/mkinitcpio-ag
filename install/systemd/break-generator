#!/bin/sh --
set -e

[[ -d "$1" ]] || exit 1
cd "$1"

service() { cat <<!
# Automatically generated by break-generator

[Service]
Type=oneshot
ExecStart=-/usr/bin/sulogin
StandardInput=tty-force
StandardOutput=inherit
StandardError=inherit
KillMode=process
IgnoreSIGPIPE=no
TasksMax=infinity
KillSignal=SIGHUP

[Unit]
Description=Initrd $1 break
SourcePath=/proc/cmdline
DefaultDependencies=no
Conflicts=shutdown.target emergency.target
!
}

premount() { cat <<!
Wants=systemd-vconsole-setup.service
After=systemd-vconsole-setup.service
Before=initrd-root-fs.target sysroot.mount systemd-fsck-root.service
!
}

postmount() { cat <<!
Wants=remote-fs.target systemd-vconsole-setup.service
After=remote-fs.target systemd-vconsole-setup.service
After=initrd.target initrd-parse-etc.service sysroot.mount
Before=initrd-cleanup.service
!
}

parse_cmdline() {
	local key value unit

	set -f
	read -r cmdline
	set -- $cmdline
	set +f

	for item; do
		case $item in
		break*|rd.break*) key=$item; break ;;
		esac
	done

	[[ $key ]] || return 0
	value=${key#*=}

	case $value in
	premount|postmount) ;;
	*) value=postmount ;;
	esac

	unit=initrd-$value-break.service

	(service $value; $value) > $unit

	mkdir -p initrd.target.wants
	ln -s ../$unit initrd.target.wants/$unit
}

parse_cmdline < /proc/cmdline
