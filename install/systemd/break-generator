#!/bin/ash --
set -e

[[ -d "$1" ]] || exit 1
cd "$1"

service() { cat <<!
# Automatically generated by break-generator

[Service]
Type=oneshot
Environment=PS1='$1 \\\\w \\\\$ '
ExecStart=-/usr/bin/sulogin
StandardInput=tty-force
StandardOutput=inherit
StandardError=inherit
KillMode=process
IgnoreSIGPIPE=no
TasksMax=infinity
KillSignal=SIGHUP
RemainAfterExit=yes

[Unit]
Description=Initrd $1 break
SourcePath=/proc/cmdline
DefaultDependencies=no
Conflicts=shutdown.target emergency.target
!
}

premount() { cat <<!
Before=sysroot.mount
!
}

postmount() { cat <<!
After=sysroot.mount
Before=initrd.target
!
}

generate() {
	local item=$1 value unit target

	for value in ${item//,/ }; do
		case $value in
		premount)
			target=sysroot.mount.requires
			;;
		*)
			target=initrd.target.requires
			value=postmount
			;;
		esac

		unit=initrd-break-$value.service

		(service $value; $value) > $unit

		mkdir -p $target
		ln -s ../$unit $target/$unit
	done
}

parse_cmdline() {
	local item

	set -f
	read -r cmdline
	set -- $cmdline
	set +f

	for item; do
		case $item in
		break*|rd.break*) generate ${item#*=} ;;
		esac
	done
}

parse_cmdline < /proc/cmdline
